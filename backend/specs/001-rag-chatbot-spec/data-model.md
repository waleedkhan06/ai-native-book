# Data Model: RAG Chatbot System

## Overview
This document defines the data entities and relationships for the RAG (Retrieval-Augmented Generation) chatbot system.

## Core Entities

### 1. Document
- **Description**: Represents a document that has been ingested into the system
- **Fields**:
  - `id` (UUID): Unique identifier for the document
  - `title` (String): Title of the document
  - `content` (Text): Full text content of the document
  - `source_url` (String): Original URL or path of the document
  - `checksum` (String): SHA-256 hash to detect changes
  - `created_at` (DateTime): Timestamp when document was ingested
  - `updated_at` (DateTime): Timestamp when document was last updated
  - `metadata` (JSON): Additional metadata about the document
  - `status` (Enum): Status of the document (INGESTED, PROCESSING, FAILED)

### 2. DocumentChunk
- **Description**: A chunk of a document that has been processed for vector storage
- **Fields**:
  - `id` (UUID): Unique identifier for the chunk
  - `document_id` (UUID): Reference to the parent document
  - `content` (Text): Text content of the chunk (typically 512-1024 tokens)
  - `chunk_order` (Integer): Order of this chunk in the original document
  - `vector_id` (String): ID in the vector database (Qdrant)
  - `embedding_model` (String): Model used to generate the embedding
  - `created_at` (DateTime): Timestamp when chunk was created

### 3. Conversation
- **Description**: A conversation session between user and chatbot
- **Fields**:
  - `id` (UUID): Unique identifier for the conversation
  - `user_id` (UUID): Reference to the user (optional for anonymous chats)
  - `title` (String): Auto-generated title for the conversation
  - `created_at` (DateTime): Timestamp when conversation started
  - `updated_at` (DateTime): Timestamp of last activity
  - `metadata` (JSON): Additional conversation metadata

### 4. Message
- **Description**: A single message in a conversation
- **Fields**:
  - `id` (UUID): Unique identifier for the message
  - `conversation_id` (UUID): Reference to the conversation
  - `role` (Enum): Role of the message (USER, ASSISTANT, SYSTEM)
  - `content` (Text): Content of the message
  - `timestamp` (DateTime): When the message was created
  - `token_count` (Integer): Number of tokens in the message
  - `sources` (JSON): Sources referenced in the response (for RAG)

### 5. User
- **Description**: Represents a user of the system
- **Fields**:
  - `id` (UUID): Unique identifier for the user
  - `email` (String): User's email address
  - `name` (String): User's display name
  - `created_at` (DateTime): When user account was created
  - `last_login_at` (DateTime): Timestamp of last login
  - `preferences` (JSON): User preferences for the chatbot

### 6. VectorIndex
- **Description**: Metadata about vector collections in Qdrant
- **Fields**:
  - `id` (UUID): Unique identifier for the index record
  - `collection_name` (String): Name of the collection in Qdrant
  - `model_name` (String): Name of the embedding model used
  - `dimension` (Integer): Dimension of the embeddings
  - `document_count` (Integer): Number of documents in the collection
  - `created_at` (DateTime): When the collection was created

### 7. QueryLog
- **Description**: Log of queries made to the system for analytics
- **Fields**:
  - `id` (UUID): Unique identifier for the log entry
  - `user_id` (UUID): Reference to the user (null for anonymous)
  - `conversation_id` (UUID): Reference to the conversation
  - `query` (Text): Original user query
  - `response` (Text): Response generated by the system
  - `retrieved_chunks` (Integer): Number of chunks retrieved for the query
  - `response_time_ms` (Integer): Time taken to generate response
  - `timestamp` (DateTime): When the query was made
  - `model_used` (String): Model that generated the response
  - `feedback_score` (Integer): Optional feedback score (1-5)

## Relationships

### Document to DocumentChunk
- One-to-Many: A document can have many chunks
- Foreign Key: `document_chunk.document_id` → `document.id`

### Conversation to Message
- One-to-Many: A conversation can have many messages
- Foreign Key: `message.conversation_id` → `conversation.id`

### User to Conversation
- One-to-Many: A user can have many conversations
- Foreign Key: `conversation.user_id` → `user.id`

## Validation Rules

### Document
- Title and content must not be empty
- Source URL must be a valid URL format
- Checksum is required for integrity verification

### DocumentChunk
- Content must not exceed 2000 characters
- Chunk order must be >= 0
- Must reference a valid document

### Conversation
- Title can be auto-generated if not provided
- Must have at least one message after creation

### Message
- Content must not be empty
- Role must be one of the defined enum values
- Must reference a valid conversation

### User
- Email must be unique and valid
- Email is required

## State Transitions

### Document Status
- `PROCESSING` → `INGESTED` (successful processing)
- `PROCESSING` → `FAILED` (error during processing)
- `INGESTED` → `PROCESSING` (when document is updated)

## Indexing Strategy

### Postgres Indexes
- Document: Index on `source_url` and `checksum` for deduplication
- DocumentChunk: Index on `document_id` and `vector_id`
- Conversation: Index on `user_id` and `updated_at`
- Message: Index on `conversation_id` and `timestamp`
- User: Index on `email` for authentication
- QueryLog: Index on `user_id`, `timestamp`, and `conversation_id`

### Qdrant Collections
- One collection per document type or use case
- Collections named with timestamp suffix for versioning
- Payload schema defined for efficient filtering